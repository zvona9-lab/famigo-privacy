name: Push worker cron

on:
  schedule:
    - cron: "*/2 * * * *"
  workflow_dispatch:

jobs:
  call-worker:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase push-worker (health)
        shell: bash
        run: |
          set -euo pipefail

          HOST="lfqomdihzsnrywqujwzw.supabase.co"
          URL="https://${HOST}/functions/v1/push-worker"

          echo "== DNS check =="
          if ! getent hosts "${HOST}" >/dev/null; then
            echo "ERROR: DNS failed for ${HOST}"
            exit 1
          fi
          echo "DNS OK"

          echo "== Request =="
          echo "URL: ${URL}"
          echo "Auth header present: $([[ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]] && echo YES || echo NO)"

          echo "== CURL =="
          HTTP_STATUS="$(
            curl -sS --show-error --location \
              --connect-timeout 15 --max-time 60 \
              -X POST "${URL}" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "User-Agent: famigo-push-cron/1.0" \
              -d '{}' \
              -o response.json \
              -w "%{http_code}"
          )"

          echo "HTTP_STATUS=${HTTP_STATUS}"

          echo "== Body (preview) =="
          # Ako je JSON, pokušaj izvući samo ključne brojke; ako nije, ispiši prvih 500 znakova
          if command -v jq >/dev/null 2>&1 && jq -e . >/dev/null 2>&1 < response.json; then
            jq '{ok, found, processed, remaining, ts}' response.json || cat response.json
          else
            head -c 500 response.json || true
            echo
          fi

          if [[ "${HTTP_STATUS}" != "200" ]]; then
            echo "ERROR: push-worker returned HTTP ${HTTP_STATUS}"
            exit 1
          fi

          echo "OK: push-worker call succeeded"
